/*!
 * project : payaction
 * author : LINOFFICE
 * 후원
 */ var sending_msg=!1;let expire_interval,order_init_number;function agree_progress(){if(!account){ncuim_modal_show("로그인 후 이용 가능합니다.");return}$("#agree_check").is(":checked")?getDatas(["/define/payaction/agree"],e=>{if(e){$(".container").html(e),ncuim_modal_show("약관 동의가 완료되었습니다.");let a=$("#chargeAmt");a&&setInputToComma(a)}},e=>{throw Error("agree_progress support.js Error")}):ncuim_modal_show("약관동의 후 진행할 수 있습니다.")}function payaction_order(){if(1==order_flag){ncuim_modal_show("이미 주문이 진행중입니다.");return}let e=$("#chargeName").val();if(!e||!e.length){ncuim_modal_show("입금자명을 입력하세요.");return}let a=$("#chargeAmt").val();if(!a||!a.length){ncuim_modal_show("입금금액을 입력하세요.");return}let r=NCoinUtils.getChargeAmt();if(0==r||""==r){ncuim_modal_show("입금금액을 입력하세요.");return}if(r%1e4!=0){ncuim_modal_show("10,000원 단위로 입력하셔야 합니다.");return}if(!account){ncuim_modal_show("로그인 후 이용 가능합니다.");return}if(!account.firstChar){ncuim_modal_show("대표 캐릭터를 찾을 수 없습니다.");return}if(!account.ingame){ncuim_modal_show("인게임에서 이용할 수 있습니다.");return}!sending_msg&&(sending_msg=!0,$(".dimmed").css("display","block"),$("#send_delay").css("display","block"),getDatasWithOption([{type:"POST",url:"/define/payaction/order",dataType:"json",contentType:"application/json",Accept:"application/json",data:{billing_name:e,order_amount:a}}],e=>{switch($("#send_delay").css("display","none"),e.code){case 1:e.order_bank_tag?payaction_matching_ready(e.order_bank_tag):(order_flag=1,order_init_number=e.order_number,payaction_order_init());break;case 2:ncuim_modal_show("후원시스템이 작동중이지 않습니다.");break;case 3:ncuim_modal_show("인게임에서 이용할 수 있습니다.");break;case 4:ncuim_modal_show("계정 정보를 찾을 수 없습니다.");break;case 5:ncuim_modal_show("대표 캐릭터를 찾을 수 없습니다.");break;case 6:ncuim_modal_show("인게임 내 케릭터를 찾을 수 없습니다.");break;case 7:ncuim_modal_show("이미 주문이 진행중입니다.");break;case 8:ncuim_modal_show("파라미터가 누락되었습니다.");break;case 9:ncuim_modal_show("주문 정보 DB저장에 실패하였습니다.");break;case 10:ncuim_modal_show("주문은 접수하였으나 API통신에 실패하였습니다. 관리자에게 문의하십시오.");break;default:ncuim_modal_show("주문에 실패하였습니다.")}sending_msg=!1},e=>{$(".dimmed").css("display","none"),$("#send_delay").css("display","none"),sending_msg=!1,ncuim_modal_show("오류가 발생하였습니다.")}))}function payaction_order_init(){ncuim_modal_show("주문이 접수되었습니다.<br/>관리자가 확인 후 입금하실 계좌를 전송받으실 수 있습니다.");let e=`<div class="order_init"><span>주문이 접수되었습니다. 관리자가 확인 후 입금계좌가 전송됩니다.</span><button class="order_init_cancel_btn">접수취소</button></div>`;$("#support_content").append(e),document.querySelector(".order_init_cancel_btn").addEventListener("click",e=>{ncuim_modal_show("정말로 취소하시겠습니까?",`payaction_order_cancel('${order_init_number}')`)})}function payaction_matching_ready(e){ncuim_modal_show("입금하실 계좌정보가 도착하였습니다. 확인 후 진행하십시오."),$(".container").html(e),payaction_matching_ready_timer(),document.querySelector(".order_cancel_btn").addEventListener("click",e=>{let a=$(".order_info .order_number .val").text();ncuim_modal_show("정말로 취소하시겠습니까?",`payaction_order_cancel('${a}')`)})}function payaction_matching_complete(e){expire_interval&&clearInterval(expire_interval),ncuim_modal_show(e),$(".bank_desc").remove(),$(".order_expire").remove(),$(".order_cancel_btn").remove(),$(".bank_info .tit").text("정상적으로 후원이 완료되었습니다."),$(".bank_info .ex").text("※ 문제가 발생되었다면 주문번호를 관리자에게 문의바랍니다."),$(".order_info").append(`<div class="col"><span class="key">완료일시</span><span class="val">${moment().format("YY.MM.DD HH:mm:ss")}</span></div>`)}function payaction_matching_cancel(){expire_interval&&clearInterval(expire_interval),ncuim_modal_show("주문시간이 만료되어 취소처리 되었습니다."),$(".bank_desc").remove(),$(".order_expire").remove(),$(".order_cancel_btn").remove(),$(".bank_info .tit").text("주문시간이 만료되어 취소처리 되었습니다."),$(".bank_info .ex").text("※ 문제가 발생되었다면 주문번호를 관리자에게 문의바랍니다."),$(".order_info").append(`<div class="col"><span class="key">취소일시</span><span class="val">${moment().format("YY.MM.DD HH:mm:ss")}</span></div>`)}function payaction_matching_ready_timer(){let e=$(".order_expire");if(e){let a=Math.floor((e.attr("data-value")-new Date().getTime())/1e3);if(a>0){let r=e.find(".val");r.text(`${a} 초`),expire_interval=setInterval(function(){r.text(`${--a} 초`),a<=0&&payaction_matching_cancel()},1e3)}}}function payaction_order_cancel(e){e&&e.length&&!sending_msg&&(sending_msg=!0,$(".dimmed").css("display","block"),$("#send_delay").css("display","block"),getDatasWithOption([{type:"POST",url:"/define/payaction/ordercancel",dataType:"json",contentType:"application/json",Accept:"application/json",data:{order_number:e}}],e=>{switch($("#send_delay").css("display","none"),e){case 1:expire_interval&&clearInterval(expire_interval),$(".order_expire").remove(),ncuim_modal_show("정상적으로 취소되었습니다.",null,"window.self.close()");break;case 2:ncuim_modal_show("후원시스템이 작동중이지 않습니다.");break;case 3:ncuim_modal_show("계정 정보를 찾을 수 없습니다.");break;case 4:ncuim_modal_show("대표 캐릭터를 찾을 수 없습니다.");break;case 5:ncuim_modal_show("진행중인 주문이 없습니다.");break;case 6:ncuim_modal_show("파라미터가 누락되었습니다.");break;case 7:ncuim_modal_show("주문정보가 올바르지 않습니다.");break;case 8:ncuim_modal_show("해당 주문은 취소 가능한 상태가 아닙니다.");break;case 9:ncuim_modal_show("API통신에 실패하였습니다. 관리자에게 문의하십시오.");break;default:ncuim_modal_show("취소에 실패하였습니다.")}sending_msg=!1},e=>{$(".dimmed").css("display","none"),$("#send_delay").css("display","none"),sending_msg=!1,ncuim_modal_show("오류가 발생하였습니다.")}))}class PAYACTION_WEBSOCKET{constructor(){}on_open(e){}on_message(e){let a=e.data;if(-1==a.indexOf("{")){console.log("not found protocol delimiter "+a);return}var r=JSON.parse(a);if(!r){console.log("not found protocol object "+a);return}if(account&&account.name&&r.user_name&&account.name==r.user_name)switch(r.type){case"PAYACTION_ORDER":payaction_matching_ready(r.message);break;case"PAYACTION_MATCHED":payaction_matching_complete(r.message)}}on_close(e){}}function chargeNameResetFade(){""==!$(".charge-name .chargeName").val()?$(".chargeName-reset").fadeIn():$(".chargeName-reset").fadeOut()}function chargeAmtResetFade(){""==!$(".charge-value .chargeAmt").val()?$(".chargeAmt-reset").fadeIn():$(".chargeAmt-reset").fadeOut()}function setChargeAmount(e){var a=$(".charge-value .chargeAmt"),r=NCoinUtils.formatCommas(e);a.val(r),show_unit()}function show_unit(){var e=$(".chargeAmt").val().length,a=48;e>0?(5==e||6==e||7==e?(e-=1,a+=10):e>=9&&(e-=1,a),$(".show-unit").length||$(".charge-value .static .wrapper").append('<p class="show-unit"><span>원</span></p>'),$(".show-unit").css({left:a+11*e})):$(".show-unit").length&&$(".charge-value .static .wrapper .show-unit").remove()}$(function(){1==order_flag&&payaction_order_init(),document.querySelector(".wrap header .btn_close").addEventListener("click",e=>{window.self.close()}),$("#agree_checkbox").on("click",function(e){let a=$("#agree_check");a.prop("checked",!a.is(":checked"))});let e=document.querySelector("#payaction_agree");e&&e.addEventListener("click",e=>{agree_progress()});let a=document.querySelector("#payaction_order");a&&a.addEventListener("click",e=>{payaction_order()});let r=document.querySelector(".order_cancel_btn");r&&r.addEventListener("click",e=>{let a=$(".order_info .order_number .val").text();ncuim_modal_show("정말로 취소하시겠습니까?",`payaction_order_cancel('${a}')`)}),$("#chargeAmt").on("keydown",function(e){let a=e.keyCode;if(17==a||18==a||!(a>=48&&a<=57||a>=96&&a<=105||8==a||9==a))return!1;var r=$(".charge-value .chargeAmt");setChargeAmount(NCoinUtils.getChargeAmt(r.val()))}),$("#chargeAmt").on("keyup",function(){var e=$(".charge-value .chargeAmt");setChargeAmount(NCoinUtils.getChargeAmt(e.val()))}),$(".charge-value .chargeAmt").on({focus:function(){$(this).parent().addClass("focus")},blur:function(){if(""==$(this).val())return $(this).parent().removeClass("focus"),$(".chargeAmt-reset").fadeOut(),!1;var e=$(".charge-value .chargeAmt");setChargeAmount(NCoinUtils.getChargeAmt(e.val())),chargeAmtResetFade()},keypress:function(){chargeAmtResetFade()}}),$("#chargeName").on("keyup",function(){chargeNameResetFade()}),$(document).on("click",".charge-value .chargeAmt-reset",function(){$(".chargeAmt").val("").focus();var e=$(".charge-value .chargeAmt");setChargeAmount(NCoinUtils.getChargeAmt(e.val())),$(".chargeAmt-reset").fadeOut()}),$(".charge-name .chargeName").on({focus:function(){$(this).parent().addClass("focus")},blur:function(){if(""==$(this).val())return $(this).parent().removeClass("focus"),$(".chargeName-reset").fadeOut(),!1;chargeNameResetFade()},keypress:function(){chargeNameResetFade()}}),$(document).on("click",".charge-name .chargeName-reset",function(){$(".chargeName").val("").focus(),$(".chargeName-reset").fadeOut()}),payaction_matching_ready_timer(),(ws_handler=new WebSocketHandler(ws_config,new PAYACTION_WEBSOCKET)).connect()});
